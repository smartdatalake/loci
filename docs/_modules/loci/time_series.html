<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>loci.time_series &mdash; loci 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> loci
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">2. Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">3. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ui.html">4. User Interface</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">loci</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>loci.time_series</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for loci.time_series</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">plotly.offline</span> <span class="k">as</span> <span class="nn">pyo</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">walk</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">pex</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">zscore</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">ImageColor</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.seasonal</span> <span class="k">import</span> <span class="n">seasonal_decompose</span>
<span class="kn">from</span> <span class="nn">statistics</span> <span class="k">import</span> <span class="n">mean</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="k">import</span> <span class="n">DBSCAN</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">ruptures</span> <span class="k">as</span> <span class="nn">rpt</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>

<div class="viewcode-block" id="DictionarySizeIsNotSupported"><a class="viewcode-back" href="../../loci.html#loci.time_series.DictionarySizeIsNotSupported">[docs]</a><span class="k">class</span> <span class="nc">DictionarySizeIsNotSupported</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="StringsAreDifferentLength"><a class="viewcode-back" href="../../loci.html#loci.time_series.StringsAreDifferentLength">[docs]</a><span class="k">class</span> <span class="nc">StringsAreDifferentLength</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="OverlapSpecifiedIsNotSmallerThanWindowSize"><a class="viewcode-back" href="../../loci.html#loci.time_series.OverlapSpecifiedIsNotSmallerThanWindowSize">[docs]</a><span class="k">class</span> <span class="nc">OverlapSpecifiedIsNotSmallerThanWindowSize</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="k">pass</span></div>

<span class="n">pyo</span><span class="o">.</span><span class="n">init_notebook_mode</span><span class="p">()</span>

<span class="c1">#---------------------------------------------------------#</span>
<span class="c1">#------------------------- SAX ---------------------------#</span>
<span class="c1">#--- source: https://github.com/serval-snt-uni-lu/dsco ---#</span>
<span class="c1">#---------------------------------------------------------#</span>
<span class="k">class</span> <span class="nc">__SAX</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class calculates the Symbolic Aggregate approXimation method (SAX) word of a given time series. In short, this translates a series of data to a string, which can then be compared with other such strings using a lookup table.</span>
<span class="sd">    </span>
<span class="sd">    Source: https://github.com/serval-snt-uni-lu/dsco</span>
<span class="sd">    </span>
<span class="sd">    :param wordSize: The SAX word length.</span>
<span class="sd">    :type wordSize: int</span>
<span class="sd">    :param alphabetSize: The alphabet size for SAX words.</span>
<span class="sd">    :type alphabetSize: int</span>
<span class="sd">    :param epsilon: Used for normalization.</span>
<span class="sd">    :type epsilon: float</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wordSize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">alphabetSize</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">alphabetSize</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">alphabetSize</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DictionarySizeIsNotSupported</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aOffset</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wordSize</span> <span class="o">=</span> <span class="n">wordSize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphabetSize</span> <span class="o">=</span> <span class="n">alphabetSize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">breakpoints</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;3&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.43</span><span class="p">,</span> <span class="mf">0.43</span><span class="p">],</span>
                            <span class="s1">&#39;4&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.67</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">],</span>
                            <span class="s1">&#39;5&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.84</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.84</span><span class="p">],</span>
                            <span class="s1">&#39;6&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.97</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.43</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.43</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">],</span>
                            <span class="s1">&#39;7&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.07</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.57</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.57</span><span class="p">,</span> <span class="mf">1.07</span><span class="p">],</span>
                            <span class="s1">&#39;8&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.15</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.67</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">],</span>
                            <span class="s1">&#39;9&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.22</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.76</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.43</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.43</span><span class="p">,</span> <span class="mf">0.76</span><span class="p">,</span> <span class="mf">1.22</span><span class="p">],</span>
                            <span class="s1">&#39;10&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.28</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.84</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.52</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.52</span><span class="p">,</span> <span class="mf">0.84</span><span class="p">,</span> <span class="mf">1.28</span><span class="p">],</span>
                            <span class="s1">&#39;11&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.34</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.91</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.35</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">,</span> <span class="mf">1.34</span><span class="p">],</span>
                            <span class="s1">&#39;12&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.38</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.97</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.67</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.43</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">,</span> <span class="mf">0.43</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">,</span> <span class="mf">1.38</span><span class="p">],</span>
                            <span class="s1">&#39;13&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.43</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.02</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.74</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.29</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.29</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.74</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.43</span><span class="p">],</span>
                            <span class="s1">&#39;14&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.47</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.07</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.79</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.57</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.37</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.37</span><span class="p">,</span> <span class="mf">0.57</span><span class="p">,</span> <span class="mf">0.79</span><span class="p">,</span> <span class="mf">1.07</span><span class="p">,</span> <span class="mf">1.47</span><span class="p">],</span>
                            <span class="s1">&#39;15&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.11</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.84</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.62</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.43</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.43</span><span class="p">,</span> <span class="mf">0.62</span><span class="p">,</span> <span class="mf">0.84</span><span class="p">,</span> <span class="mf">1.11</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
                            <span class="s1">&#39;16&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.53</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.15</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.89</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.67</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.49</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.32</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.32</span><span class="p">,</span> <span class="mf">0.49</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.89</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">,</span> <span class="mf">1.53</span><span class="p">],</span>
                            <span class="s1">&#39;17&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.56</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.19</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.93</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.72</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.54</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.38</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.22</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.38</span><span class="p">,</span> <span class="mf">0.54</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">,</span> <span class="mf">0.93</span><span class="p">,</span> <span class="mf">1.19</span><span class="p">,</span> <span class="mf">1.56</span><span class="p">],</span>
                            <span class="s1">&#39;18&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.59</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.22</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.97</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.76</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.59</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.43</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.28</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.14</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="mf">0.28</span><span class="p">,</span> <span class="mf">0.43</span><span class="p">,</span> <span class="mf">0.59</span><span class="p">,</span> <span class="mf">0.76</span><span class="p">,</span> <span class="mf">0.97</span><span class="p">,</span> <span class="mf">1.22</span><span class="p">,</span> <span class="mf">1.59</span><span class="p">],</span>
                            <span class="s1">&#39;19&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.62</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.25</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.63</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.48</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.34</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">,</span> <span class="mf">0.48</span><span class="p">,</span> <span class="mf">0.63</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.62</span><span class="p">],</span>
                            <span class="s1">&#39;20&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.64</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.28</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.04</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.84</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.67</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.52</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.39</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.13</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.39</span><span class="p">,</span> <span class="mf">0.52</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.84</span><span class="p">,</span> <span class="mf">1.04</span><span class="p">,</span> <span class="mf">1.28</span><span class="p">,</span> <span class="mf">1.64</span><span class="p">]</span>
                            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">breakpoints</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphabetSize</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_letter_compare_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalingFactor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_breakpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the SAX breakpoint set.</span>
<span class="sd">        </span>
<span class="sd">        :return: A dictionary containing the breakpoints.</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">to_letter_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function takes a series of data, x, and transforms it to a string representation.</span>
<span class="sd">        </span>
<span class="sd">        :param x: The input data.</span>
<span class="sd">        :type x: list</span>
<span class="sd">        :return: The corresponding string representation.</span>
<span class="sd">        :rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">paaX</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_PAA</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalingFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wordSize</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alphabetize</span><span class="p">(</span><span class="n">paaX</span><span class="p">),</span> <span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function will z-normalize an array (give it a mean of 0, and a standard deviation of 1) unless it&#39;s standard deviation is below epsilon, in which case it returns an array of zeros the length of the original array.</span>
<span class="sd">        </span>
<span class="sd">        :param x: The input array.</span>
<span class="sd">        :type x: list</span>
<span class="sd">        :return: The z-normalized array.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">X</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_PAA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function performs Piecewise Aggregate Approximation (PAA) on data set, reducing the dimension of the dataset x to w discrete levels. It returns the reduced dimension data set, as well as the indices corresponding to the original data for each reduced dimension</span>
<span class="sd">        </span>
<span class="sd">        :param x: The input array.</span>
<span class="sd">        :type x: list</span>
<span class="sd">        :return: The PAA array.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">stepFloat</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wordSize</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">stepFloat</span><span class="p">))</span>
        <span class="n">frameStart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">approximation</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">frameStart</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">-</span><span class="n">step</span><span class="p">:</span>
            <span class="n">thisFrame</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">frameStart</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">frameStart</span> <span class="o">+</span> <span class="n">step</span><span class="p">)])</span>
            <span class="n">approximation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">thisFrame</span><span class="p">))</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">frameStart</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">frameStart</span> <span class="o">+</span> <span class="n">step</span><span class="p">)))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">frameStart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">stepFloat</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">approximation</span><span class="p">),</span> <span class="n">indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">alphabetize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paaX</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function converts the Piecewise Aggregate Approximation (PAA) of x to a series of letters.</span>
<span class="sd">        </span>
<span class="sd">        :param paaX: The input PAA array.</span>
<span class="sd">        :type x: list</span>
<span class="sd">        :return: The resulting series of letters.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alphabetizedX</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">paaX</span><span class="p">)):</span>
            <span class="n">letterFound</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">paaX</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">alphabetizedX</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span>
                    <span class="n">letterFound</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">paaX</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">alphabetizedX</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aOffset</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
                    <span class="n">letterFound</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">letterFound</span><span class="p">:</span>
                <span class="n">alphabetizedX</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aOffset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">alphabetizedX</span>

    <span class="k">def</span> <span class="nf">compare_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sA</span><span class="p">,</span> <span class="n">sB</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function compares two strings based on individual letter distance. It requires that both strings are the same length.</span>
<span class="sd">        </span>
<span class="sd">        :param sA: The first string.</span>
<span class="sd">        :type sA: string</span>
<span class="sd">        :param sB: The second string.</span>
<span class="sd">        :type sB: string</span>
<span class="sd">        :return: The resulting letter distance.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sA</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sB</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">StringsAreDifferentLength</span><span class="p">()</span>
        <span class="n">list_letters_a</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sA</span><span class="p">]</span>
        <span class="n">list_letters_b</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sB</span><span class="p">]</span>
        <span class="n">mindist</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_letters_a</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">list_letters_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="n">list_letters_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">mindist</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_letters</span><span class="p">(</span><span class="n">list_letters_a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">list_letters_b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">mindist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalingFactor</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mindist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mindist</span>

    <span class="k">def</span> <span class="nf">compare_letters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">la</span><span class="p">,</span> <span class="n">lb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function compares two letters based on their letter distance.</span>
<span class="sd">        </span>
<span class="sd">        :param la: The first letter.</span>
<span class="sd">        :type la: string</span>
<span class="sd">        :param lb: The second letter.</span>
<span class="sd">        :type lb: string</span>
<span class="sd">        :return: The resulting letter distance.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareDict</span><span class="p">[</span><span class="n">la</span><span class="o">+</span><span class="n">lb</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">build_letter_compare_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function builds up the lookup table to determine numeric distance between two letters given an alphabet size.  Entries for both &#39;ab&#39; and &#39;ba&#39; will be created and will have identical values.</span>
<span class="sd">        </span>
<span class="sd">        :return: None.</span>
<span class="sd">        :rtype: none</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">number_rep</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">alphabetSize</span><span class="p">)</span>
        <span class="n">letters</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">aOffset</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">number_rep</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compareDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">letters</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">letters</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">number_rep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">number_rep</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compareDict</span><span class="p">[</span><span class="n">letters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">letters</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">high_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">number_rep</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">number_rep</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">low_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">number_rep</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">number_rep</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compareDict</span><span class="p">[</span><span class="n">letters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">letters</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">high_num</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">low_num</span><span class="p">]</span>
        
        
<span class="c1">#-------------------------------------#</span>
<span class="c1">#------ OTHER TS FUNCTIONS -----------#</span>
<span class="c1">#-------------------------------------#</span>
<div class="viewcode-block" id="read_files"><a class="viewcode-back" href="../../loci.html#loci.time_series.read_files">[docs]</a><span class="k">def</span> <span class="nf">read_files</span><span class="p">(</span><span class="n">my_path</span><span class="p">,</span> <span class="n">date_column</span><span class="p">,</span> <span class="n">data_column</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads all the co-evolving time series files contained in the given path in a Pandas dataframe.</span>
<span class="sd">    </span>
<span class="sd">    :param my_path: The path containing the time series files.</span>
<span class="sd">    :type my_path: string</span>
<span class="sd">    :param date_column: The column number containing the datetime of each entry in each file.</span>
<span class="sd">    :type date_column: int</span>
<span class="sd">    :param data_column: The column number containing the values in each file.</span>
<span class="sd">    :type data_column: int</span>
<span class="sd">    :param date_format: The format of the date.</span>
<span class="sd">    :type date_format: string</span>
<span class="sd">    :return:</span>
<span class="sd">        -df_array (:py:class:&#39;list&#39;) - A list containing a Pandas dataframe for each read time series.</span>
<span class="sd">        -filenames (:py:class:&#39;list&#39;) - A list containing all read filenames.</span>
<span class="sd">        -start_date (:py:class:&#39;datetime&#39;) - The starting datetime of all time series.</span>
<span class="sd">        -end-date (:py:class:&#39;datetime&#39;) - The ending datetime of all time series.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">walk</span><span class="p">(</span><span class="n">my_path</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]))[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">my_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">start_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;.DS_Store&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">my_path</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
                
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">date_column</span><span class="p">]</span>
                <span class="n">end_date</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">date_column</span><span class="p">]</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;normalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">data_column</span><span class="p">])</span>
            <span class="n">df_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_array</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span></div>

<div class="viewcode-block" id="read_file"><a class="viewcode-back" href="../../loci.html#loci.time_series.read_file">[docs]</a><span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">my_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a single time series from the given file.</span>
<span class="sd">    </span>
<span class="sd">    :param my_path: The file</span>
<span class="sd">    :type my_path: string</span>
<span class="sd">    :return: A Pandas dataframe containing the read time series.</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">my_file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">df</span></div>
        
<span class="k">def</span> <span class="nf">__get_date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">intv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of dates within a given range.</span>
<span class="sd">    </span>
<span class="sd">    :param start: The starting date.</span>
<span class="sd">    :type start: datetime</span>
<span class="sd">    :param end: The ending date.</span>
<span class="sd">    :type end: datetime</span>
<span class="sd">    :param intv: The interval between dates (in days).</span>
<span class="sd">    :type intv: int</span>
<span class="sd">    :return: A list of dates.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span>  <span class="o">-</span> <span class="n">start</span> <span class="p">)</span> <span class="o">/</span> <span class="n">intv</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">intv</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y&quot;</span><span class="p">)</span>    

<div class="viewcode-block" id="create_sankey"><a class="viewcode-back" href="../../loci.html#loci.time_series.create_sankey">[docs]</a><span class="k">def</span> <span class="nf">create_sankey</span><span class="p">(</span><span class="n">df_array</span><span class="p">,</span> <span class="n">alphabet_size</span><span class="p">,</span> <span class="n">word_size</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">from_value</span><span class="p">,</span> <span class="n">to_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method generates and returns an interactive, Plotly-based SankeyTS diagram. The bands and flows of the diagram are generated based on the SAX words of the loaded set of time series.</span>
<span class="sd">    </span>
<span class="sd">    :param df_array: A list containing a Pandas dataframe for each read time series.</span>
<span class="sd">    :type df_array: list</span>
<span class="sd">    :param alphabet_size: The alphabet size for SAX encoding.</span>
<span class="sd">    :type alphabet_size: int</span>
<span class="sd">    :param word_size: The SAX word length.</span>
<span class="sd">    :type word_size: int</span>
<span class="sd">    :param begin: The starting date for the SankeyTS diagram.</span>
<span class="sd">    :type begin: datetime</span>
<span class="sd">    :param end: The ending date for the SankeyTS diagram.</span>
<span class="sd">    :type end: datetime</span>
<span class="sd">    :param from_value: The starting value for the SankeyTS diagram.</span>
<span class="sd">    :type from_value: float</span>
<span class="sd">    :param to_value: The ending value for the SankeyTS diagram.</span>
<span class="sd">    :type to_value: float</span>
<span class="sd">    :return: A SankeyTS diagram.</span>
<span class="sd">    :rtype: plotly.graph_objects.figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sax</span> <span class="o">=</span> <span class="n">__SAX</span><span class="p">(</span><span class="n">wordSize</span> <span class="o">=</span> <span class="n">word_size</span><span class="p">,</span> <span class="n">alphabetSize</span> <span class="o">=</span> <span class="n">alphabet_size</span><span class="p">)</span>
    <span class="n">breakpoints</span> <span class="o">=</span> <span class="n">sax</span><span class="o">.</span><span class="n">get_breakpoints</span><span class="p">()</span>
    <span class="n">breakpoints</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">))</span>
    <span class="n">breakpoints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="s2">&quot;+inf&quot;</span><span class="p">))</span>
    <span class="n">date_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">__get_date_range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">word_size</span><span class="p">))</span>
    <span class="n">alphabet</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">))</span>
    <span class="n">alphabet_inv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">26</span><span class="p">)))</span>

    <span class="n">label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">node_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">node_y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">step_x</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">word_size</span><span class="p">)</span>
    <span class="n">step_y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">alphabet_size</span><span class="p">)</span>
    <span class="n">curr_x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">curr_y</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">breakpoint_intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">word_size</span><span class="p">):</span>
        <span class="n">curr_x</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">step_x</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">alphabet_size</span><span class="p">):</span>
            <span class="n">curr_y</span> <span class="o">=</span> <span class="n">j</span><span class="o">*</span><span class="n">step_y</span>
            <span class="n">label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alphabet</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">node_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_x</span><span class="o">+</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">node_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr_y</span><span class="o">+</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date_range</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">breakpoint_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;from &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">[</span><span class="n">alphabet_size</span><span class="o">-</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">breakpoints</span><span class="p">[</span><span class="n">alphabet_size</span><span class="o">-</span><span class="n">j</span><span class="p">]))</span>

    <span class="n">source_target_value</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">node_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_array</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">begin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;normalized&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">from_value</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;normalized&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">to_value</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;normalized&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">sax_rep</span> <span class="o">=</span> <span class="n">sax</span><span class="o">.</span><span class="n">to_letter_rep</span><span class="p">(</span><span class="n">signal</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sax_rep</span><span class="p">)):</span>
            <span class="n">source_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">alphabet_inv</span><span class="p">[</span><span class="n">sax_rep</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">+</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">alphabet_size</span><span class="p">),</span> <span class="n">alphabet_inv</span><span class="p">[</span><span class="n">sax_rep</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">alphabet_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">source_target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source_target_value</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">source_target_value</span><span class="p">[</span><span class="n">source_target</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source_target_value</span><span class="p">[</span><span class="n">source_target</span><span class="p">]</span> <span class="o">=</span> <span class="n">source_target_value</span><span class="p">[</span><span class="n">source_target</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">node_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_target</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">node_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_target</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">node_x_pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">node_y_pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">node_set</span><span class="p">):</span>
        <span class="n">node_x_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">node_y_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">source</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">source_target_value</span><span class="p">:</span>
        <span class="n">source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">source_target_value</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

    <span class="n">pal1</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Spectral&quot;</span><span class="p">,</span> <span class="n">alphabet_size</span><span class="p">)</span>
    <span class="n">pal1</span> <span class="o">=</span> <span class="n">pal1</span><span class="o">.</span><span class="n">as_hex</span><span class="p">()</span>

    <span class="n">node_colors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">label</span><span class="p">)):</span>
        <span class="n">node_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pal1</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">alphabet_size</span><span class="p">)])</span>

    <span class="n">link_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">node_colors</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span>
    <span class="n">link_breakpoint_intervals</span> <span class="o">=</span> <span class="p">[</span><span class="n">breakpoint_intervals</span><span class="p">[</span><span class="n">src</span><span class="p">]</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">source</span><span class="p">]</span>

    <span class="n">link_colors_rgb</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">link_colors</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">ImageColor</span><span class="o">.</span><span class="n">getcolor</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="n">link_colors_rgb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rgba(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rgb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rgb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rgb</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Sankey</span><span class="p">(</span>
        <span class="n">valueformat</span> <span class="o">=</span> <span class="s2">&quot;.0f&quot;</span><span class="p">,</span>
        <span class="n">textfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">arrangement</span> <span class="o">=</span> <span class="s1">&#39;snap&#39;</span><span class="p">,</span>
        <span class="n">node</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
          <span class="n">pad</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
          <span class="n">thickness</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
          <span class="n">line</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">1.75</span><span class="p">),</span>
          <span class="n">label</span> <span class="o">=</span> <span class="n">dates</span><span class="p">,</span>
          <span class="n">customdata</span> <span class="o">=</span> <span class="n">breakpoint_intervals</span><span class="p">,</span>
          <span class="n">x</span><span class="o">=</span><span class="n">node_x_pos</span><span class="p">,</span>
          <span class="n">y</span><span class="o">=</span><span class="n">node_y_pos</span><span class="p">,</span>
          <span class="n">color</span> <span class="o">=</span> <span class="n">node_colors</span><span class="p">,</span>
          <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Value range %</span><span class="si">{customdata}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">link</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
          <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">,</span>
          <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span>
          <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">,</span>
          <span class="n">line</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">),</span>
          <span class="n">color</span> <span class="o">=</span>  <span class="n">link_colors_rgb</span><span class="p">,</span>
          <span class="n">customdata</span> <span class="o">=</span> <span class="n">link_breakpoint_intervals</span><span class="p">,</span>
          <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Count: %</span><span class="si">{value}</span><span class="s1"> &lt;br /&gt;From %</span><span class="si">{source.label}</span><span class="s1"> to %</span><span class="si">{target.label}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
    <span class="p">))])</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>


<span class="k">def</span> <span class="nf">__get_gain_index</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span> <span class="n">seasonality</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">real_values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method takes as input the trend, seasonality the model type as well as the real values of the time series and calculates the gain index. The gain index expresses the contribution of the seasonality to the actual time series. In order to calculate it we calculate the percentage difference between the percentage error of trend vs actual time series and percentage error of trend + seasonality vs actual time series. The higher this index is, the more likely is for the time series to have a strong seasonality component.</span>
<span class="sd">    </span>
<span class="sd">    :param trend: The Trend component.</span>
<span class="sd">    :type trend: list</span>
<span class="sd">    :param seasonality: The Seasonal component.</span>
<span class="sd">    :type seasonality: list</span>
<span class="sd">    :param model: The type of the model, &#39;additive&#39; or &#39;multiplicative&#39;.</span>
<span class="sd">    :type model: string</span>
<span class="sd">    :return: The gain index, a percentage which expresses the contribution of the seasonal component.</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error1</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># error between trend vs actual values</span>
    <span class="n">error2</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># error between trend + seasonality vs actual values</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">real_values</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">real_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;Additive&#39;</span><span class="p">:</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
                <span class="n">real</span> <span class="o">=</span> <span class="n">real_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">error1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">real</span><span class="o">-</span><span class="n">predicted</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">real</span><span class="p">))</span>
                
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">seasonality</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">real</span> <span class="o">=</span> <span class="n">real_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">error2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">real</span><span class="o">-</span><span class="n">predicted</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">real</span><span class="p">))</span>            
            
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;Multiplicative&#39;</span><span class="p">:</span>
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
                <span class="n">real</span> <span class="o">=</span> <span class="n">real_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">error1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">real</span><span class="o">-</span><span class="n">predicted</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">real</span><span class="p">))</span>
                
                <span class="n">predicted</span> <span class="o">=</span> <span class="n">trend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">seasonality</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">real</span> <span class="o">=</span> <span class="n">real_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">error2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">real</span><span class="o">-</span><span class="n">predicted</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">real</span><span class="p">))</span>
        
    <span class="n">error</span> <span class="o">=</span>  <span class="p">(</span><span class="n">mean</span><span class="p">(</span><span class="n">error1</span><span class="p">)</span> <span class="o">-</span> <span class="n">mean</span><span class="p">(</span><span class="n">error2</span><span class="p">))</span> <span class="o">/</span> <span class="n">mean</span><span class="p">(</span><span class="n">error1</span><span class="p">)</span>          
    
    <span class="k">return</span> <span class="n">error</span>


<span class="k">def</span> <span class="nf">__extract_best_period</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method decomposes the provided time series using all the provided periods and selects the one that gives the highest gain index. It also returns the calculated gain indexes for all the tested periods. The gain index expresses the contribution of the seasonality to the actual time series. In order to calculate it we calculate the percentage difference between the percentage error of trend vs actual time series and percentage error of trend + seasonality vs actual time series. The higher this index is the more likely is for the time series to have a strong seasonality component.</span>
<span class="sd">    </span>
<span class="sd">    :param ts:A list containing the time series values.</span>
<span class="sd">    :type ts: list</span>
<span class="sd">    :param dates: A list of datetime objects corresponding to the time series values.</span>
<span class="sd">    :type dates: list</span>
<span class="sd">    :param periods: A list containing the periods to be tested.</span>
<span class="sd">    :type periods: list</span>
<span class="sd">    :param model: The type of the model, &#39;additive&#39; or &#39;multiplicative&#39;.</span>
<span class="sd">    :type model: string</span>
<span class="sd">    :return:</span>
<span class="sd">        -p (:py:class:&#39;int&#39;) - The selected period (the one that gives the highest gain index).</span>
<span class="sd">        -periods_gain_indexes (:py:class:&#39;json&#39;) - A json with the {period:gain_index} for all the tested periods.        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define gain_index and period</span>
    <span class="n">gain_index</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span> 
    <span class="n">p</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># best period</span>
    <span class="n">periods_gain_indexes</span> <span class="o">=</span> <span class="p">{}</span> 
    <span class="n">m</span> <span class="o">=</span> <span class="n">model</span>
    
    <span class="c1"># Apply z-normalisation to the time series</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">zscore</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
    
    <span class="c1"># Check if dates are provided and create a df</span>
    <span class="k">if</span> <span class="n">dates</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        
        <span class="c1"># Create df</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;DATE&#39;</span><span class="p">:</span><span class="n">dates</span><span class="p">,</span><span class="s1">&#39;values&#39;</span><span class="p">:</span><span class="n">ts</span><span class="p">}</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        
        <span class="c1"># create datetime index passing the datetime series</span>
        <span class="n">datetime_index</span> <span class="o">=</span><span class="n">ts</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span>
        
        <span class="c1"># Complete the call to convert the date column</span>
        <span class="n">datetime_index</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">datetime_index</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">)</span>
        <span class="n">ts</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">datetime_index</span><span class="p">)</span>
        <span class="c1"># we don&#39;t need the column anymore</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;DATE&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    
    <span class="c1"># Find the period with the smallest mean_abs error</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
        
        <span class="c1"># Seasonal decomposition</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
        
        <span class="n">trend</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">trend</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">trend</span><span class="p">)</span>
        <span class="n">seasonality</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">seasonal</span><span class="p">),</span><span class="kc">None</span><span class="p">,</span><span class="n">result</span><span class="o">.</span><span class="n">seasonal</span><span class="p">)</span>
        <span class="n">res_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">resid</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
        
        <span class="n">g</span> <span class="o">=</span> <span class="n">__get_gain_index</span><span class="p">(</span><span class="n">trend</span><span class="p">,</span><span class="n">seasonality</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">m</span><span class="p">,</span><span class="n">real_values</span><span class="o">=</span><span class="n">ts</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">g</span> <span class="o">&gt;</span> <span class="n">gain_index</span><span class="p">:</span>
            <span class="n">gain_index</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">i</span>
            
        <span class="n">periods_gain_indexes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span><span class="n">g</span><span class="p">})</span>
        
    <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">periods_gain_indexes</span>


<div class="viewcode-block" id="seasonal_decomposition"><a class="viewcode-back" href="../../loci.html#loci.time_series.seasonal_decomposition">[docs]</a><span class="k">def</span> <span class="nf">seasonal_decomposition</span><span class="p">(</span><span class="n">ts_df</span><span class="p">,</span> <span class="n">date_column</span><span class="p">,</span> <span class="n">data_column</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    This method performs the Triple Time Series Decomposition. The service takes as input a time series, the corresponding model type (&quot;Multiplicative&quot; or &quot;Additive&quot;), a list of periods parameters and the corresponding locale if applicable. The user can insert the path of the selected data or provide them in an array form. If the user provides more than 1 period parameters, the method selects the best one according to the best gain index. The provided time series is decomposed into three distinct components according to the selected model and period:</span>
<span class="sd">        </span>
<span class="sd">    - Trend: the increasing - decreasing value in the series.</span>
<span class="sd">    - Seasonality: the repeating short term cycle in the series.</span>
<span class="sd">    - Residual Error: the random variation in the series.</span>

<span class="sd">    An additive model suggests that the components are added toghether as follows:</span>
<span class="sd">    - y(t) = Trend + Seasonality + Residual Error</span>

<span class="sd">    While a multilicative model suggests that components are multiplied together as follows:</span>
<span class="sd">    - y(t) = Trend * Seasonality * Residual Error</span>

<span class="sd">    This implementation uses the &quot;statsmodels.tsa.seasonal.seasonal_decompose&quot; from the statsmodels library.</span>
<span class="sd">    </span>
<span class="sd">    :param ts_df: A Pandas dataframe containing the loaded time series.</span>
<span class="sd">    :type ts_df: pandas.DataFrame</span>
<span class="sd">    :param date_column: The column number containing the datetime of each entry in each file.</span>
<span class="sd">    :type date_column: int</span>
<span class="sd">    :param data_column: The column number containing the values in each file.</span>
<span class="sd">    :type data_column: int</span>
<span class="sd">    :param periods: A list containing the periods to be tested.</span>
<span class="sd">    :type periods: list</span>
<span class="sd">    :param m: The type of the model, &#39;additive&#39; or &#39;multiplicative&#39;.</span>
<span class="sd">    :type m: string</span>
<span class="sd">    :return:</span>
<span class="sd">        -result (:py:class:&#39;statsmodels.tsa.seasonal.seasonal_decompose&#39;) - The result of the seasonal decomposition.</span>
<span class="sd">        -best_period (:py:class:&#39;json&#39;) - The selected best period based on the minimum mean absolute value of the residual error component.</span>
<span class="sd">        -gain_indexes (:py:class:&#39;json&#39;) - A json with the {period:gain_index} for all the tested periods.</span>
<span class="sd">        -fig1 (:py:class:&#39;plotly.express&#39;) - A Potly figure containing the trend, seasonality and residual error components.</span>
<span class="sd">        -fig2 (:py:class:&#39;plotly.express&#39;) - A Potly figure containing the seasonality component.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">best_period</span><span class="p">,</span> <span class="n">gain_indexes</span> <span class="o">=</span> <span class="n">__extract_best_period</span><span class="p">(</span><span class="n">ts_df</span><span class="p">[</span><span class="n">data_column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">ts_df</span><span class="p">[</span><span class="n">date_column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">periods</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">seasonal_decompose</span><span class="p">(</span><span class="n">ts_df</span><span class="p">[</span><span class="n">data_column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">period</span><span class="o">=</span><span class="n">best_period</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">m</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">ts_df</span><span class="p">[</span><span class="n">date_column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
     <span class="s1">&#39;Trend&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">trend</span><span class="p">,</span>
     <span class="s1">&#39;Seasonality&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span>
     <span class="s1">&#39;Residual&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">resid</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
    
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">fig1</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">fig2</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">best_period</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">best_period</span><span class="o">+</span><span class="mi">1</span><span class="p">))],</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Seasonality&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Seasonality&#39;</span><span class="p">)</span>
    
    <span class="c1">#return result, best_period, gain_indexes, fig1, fig2, fig3</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">best_period</span><span class="p">,</span> <span class="n">gain_indexes</span><span class="p">,</span> <span class="n">fig1</span><span class="p">,</span> <span class="n">fig2</span></div>

<span class="k">def</span> <span class="nf">__rate_change</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">changepoints</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method takes as input the data and the change points and calculates the absolute and directional rate change. Rate change is a metric that expresses the significance of a changing point. In order to calculate it we take the absolute percentage difference between the average values of two consecutive segments given a selected window.</span>
<span class="sd">    </span>
<span class="sd">    :param data: A list containing the time series values.</span>
<span class="sd">    :type data: list</span>
<span class="sd">    :param changepoints: The discovered change points.</span>
<span class="sd">    :type changepoints: list</span>
<span class="sd">    :return:</span>
<span class="sd">        -rate_changes (:py:class:&#39;dict&#39;) - The change points along with their absolute rate change.</span>
<span class="sd">        -dir_rate_changes (:py:class:&#39;dict&#39;) - The change points along with their direcitonal rate change.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Initialise a dictionary that holds the changing points and their rate of change</span>
    <span class="n">rate_changes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dir_rate_changes</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="c1"># Convert the data into pandas format</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">changepoints</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
        
        <span class="c1"># Take the corresponding segments</span>
        <span class="n">segment1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">changepoints</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">changepoints</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">segment2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">changepoints</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span><span class="n">changepoints</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]]</span>
        
        <span class="c1"># Calculate their average value</span>
        <span class="n">mean1</span> <span class="o">=</span> <span class="n">segment1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mean2</span> <span class="o">=</span> <span class="n">segment2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Calculate their absolute percentage difference</span>
       
        <span class="n">abs_percentage_diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">mean2</span> <span class="o">-</span> <span class="n">mean1</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">mean1</span><span class="o">+</span><span class="n">mean2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
       
        <span class="n">dir_percentage_diff</span> <span class="o">=</span> <span class="p">((</span><span class="n">mean2</span> <span class="o">-</span> <span class="n">mean1</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">mean1</span><span class="o">+</span><span class="n">mean2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="c1"># Update rate_changes</span>
        <span class="n">rate_changes</span><span class="p">[</span><span class="n">changepoints</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">abs_percentage_diff</span> 
        <span class="n">dir_rate_changes</span><span class="p">[</span><span class="n">changepoints</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dir_percentage_diff</span>
        
       
    <span class="k">return</span> <span class="n">rate_changes</span><span class="p">,</span> <span class="n">dir_rate_changes</span>

<div class="viewcode-block" id="change_setection_single"><a class="viewcode-back" href="../../loci.html#loci.time_series.change_setection_single">[docs]</a><span class="k">def</span> <span class="nf">change_setection_single</span><span class="p">(</span><span class="n">ts_df</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">min_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method identifies the change points within a single time series using the PELT approach (i.e., from the ruptures library: https://centre-borelli.github.io/ruptures-docs/user-guide/detection/pelt/).</span>
<span class="sd">    </span>
<span class="sd">    :param ts_df: A Pandas dataframe containing the loaded time series</span>
<span class="sd">    :type ts_df: pandas.DataFrame</span>
<span class="sd">    :param model: The desired PELT model (can be either &quot;l1&quot;, &quot;l2&quot;, &quot;normal&quot;, &quot;rbf&quot;, &quot;linear&quot;, or &quot;ar&quot;</span>
<span class="sd">    :type model: string</span>
<span class="sd">    :param min_size: The minimum distance (in number of timestamps) between two consecutive change points.</span>
<span class="sd">    :type min_size: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">ts_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">algo</span> <span class="o">=</span> <span class="n">rpt</span><span class="o">.</span><span class="n">Pelt</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">jump</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    <span class="n">my_bkps</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,)</span> <span class="o">=</span> <span class="n">rpt</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">my_bkps</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="change_detection_collective"><a class="viewcode-back" href="../../loci.html#loci.time_series.change_detection_collective">[docs]</a><span class="k">def</span> <span class="nf">change_detection_collective</span><span class="p">(</span><span class="n">ts_df_array</span><span class="p">,</span> <span class="n">filenames</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="p">,</span> <span class="n">date_column</span><span class="p">,</span> <span class="n">data_column</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method identifies the change points within a collection of time series, ranks them and distinguishes them between global and local changes. In order to find the changing points, our implementation uses the PELT approach (from the ruptures library) and calculates their rate change metric. Subsequently, using DBSCAN, it creates some clusters which include the change points that are part of the same global change.</span>
<span class="sd">    </span>
<span class="sd">    :param ts_df_array: A list of Pandas dataframes containing the loaded time series.</span>
<span class="sd">    :type ts_df_array: list</span>
<span class="sd">    :param filenames: The corresponding filename of each time series.</span>
<span class="sd">    :type filenames: list</span>
<span class="sd">    :param model: The desired PELT model (can be either &quot;l1&quot;, &quot;l2&quot;, &quot;normal&quot;, &quot;rbf&quot;, &quot;linear&quot;, or &quot;ar&quot;.</span>
<span class="sd">    :type model: string</span>
<span class="sd">    :param min_size: Minimum number of samples between two change points (ruptures).</span>
<span class="sd">    :type min_size: int</span>
<span class="sd">    :param eps: he maximum distance between two samples for one to be considered as in the neighborhood of the other. This is not a maximum bound on the distances of points within a cluster (DBSCAN).</span>
<span class="sd">    :type eps: int</span>
<span class="sd">    :param min_samples: The number of samples (or total weight) in a neighborhood for a point to be considered as a core point. This includes the point itself (DBSCAN).</span>
<span class="sd">    :type min_samples: int</span>
<span class="sd">    :param date_column: The column number containing the datetime of each entry in each file.</span>
<span class="sd">    :type date_column: int</span>
<span class="sd">    :param data_column: The column number containing the values in each file.</span>
<span class="sd">    :type data_column: int</span>
<span class="sd">    :return:</span>
<span class="sd">        -final_data (:py:class:&#39;dict&#39;) - A dictionary containing the timestamps/dates of the identified change points, the name or id of the corresponding time series, the rate change of the change points, local-global cluster label (-1 stands for local changes).</span>
<span class="sd">        -data_clusters (:py:class:&#39;dict&#39;) - A dictionary containing all the identified clusters (global changes), their aggregate and absolute aggregate rate changes and corresponding cluster scores, their starting and ending date or timestamp and the number of members of each cluster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create Final Dataset</span>
    <span class="n">final_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">,</span><span class="s1">&#39;rate_change&#39;</span><span class="p">,</span><span class="s1">&#39;dir_rate_change&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
    <span class="n">num_of_stock</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">sftp_v</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Iterate through the provided list with the stocks</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_df_array</span><span class="p">)):</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">ts_df_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">data_column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># closing values</span>
        <span class="n">stock_dates</span> <span class="o">=</span> <span class="n">ts_df_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">date_column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="c1"># dates of the specific stock</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">values</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">num_of_stock</span>
        <span class="n">num_of_stock</span> <span class="o">=</span> <span class="n">filenames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Set up parameters for ruptures</span>
        <span class="c1"># ------------------------------</span>
        <span class="n">jump</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">d</span>

        <span class="c1"># Fit the model</span>
        <span class="c1"># -------------</span>
        <span class="n">algo</span> <span class="o">=</span> <span class="n">rpt</span><span class="o">.</span><span class="n">Pelt</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span><span class="p">,</span> <span class="n">jump</span><span class="o">=</span><span class="n">jump</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="n">my_bkps</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pen</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>


        <span class="c1"># Calculate the rate of changes </span>
        <span class="c1"># -----------------------------</span>
        <span class="n">my_bkps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">results</span><span class="p">,</span><span class="n">dir_results</span> <span class="o">=</span> <span class="n">__rate_change</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span><span class="n">my_bkps</span><span class="p">)</span>


        <span class="c1"># Create the final dataset</span>
        <span class="c1"># -----------------------</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">,</span><span class="s1">&#39;rate_change&#39;</span><span class="p">])</span>                 
        <span class="n">dir_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dir_results</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">,</span><span class="s1">&#39;dir_rate_change&#39;</span><span class="p">])</span>               
        <span class="n">dir_rate_values</span> <span class="o">=</span> <span class="n">dir_df</span><span class="p">[</span><span class="s1">&#39;dir_rate_change&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>         
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dir_rate_change&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir_rate_values</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span>   


        <span class="c1"># Add dates if exist</span>
        <span class="c1"># ------------------        </span>
        <span class="n">changepoints</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">changepoints_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">changepoints</span><span class="p">:</span>
            <span class="n">changepoints_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stock_dates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">changepoints_dates</span><span class="p">)</span>
        <span class="n">final_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">final_data</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Sort the changing points according to rate change index</span>
    <span class="c1"># -------------------------------------------------------</span>
    <span class="n">final_data</span>  <span class="o">=</span> <span class="n">final_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;rate_change&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="c1"># DBSCAN for identifying Global - Local changes</span>
    <span class="c1"># ----------------------------------------------</span>

    <span class="c1"># ake the extracted timestamps of the changing points from the whole collection</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">final_data</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">timestamps</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Call the DBSCAN algorithm</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="n">min_samples</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">core_samples_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">labels_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">core_samples_mask</span><span class="p">[</span><span class="n">db</span><span class="o">.</span><span class="n">core_sample_indices_</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">labels_</span>
    
    <span class="n">n_clusters_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">n_noise_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add labels to the data</span>
    <span class="n">final_data</span><span class="p">[</span><span class="s1">&#39;cluster label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>


    <span class="c1"># Cluster datarame</span>
    <span class="c1"># ----------------</span>

    <span class="c1"># Create a new df for the cluster dataframe</span>
    <span class="n">data_changes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">final_data</span><span class="p">)</span>

    <span class="c1"># convert timestamps column to floats</span>
    <span class="n">data_changes</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_changes</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>



    <span class="c1"># get mean rate_change</span>
    <span class="n">data_clusters</span> <span class="o">=</span> <span class="n">data_changes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cluster label&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">[</span><span class="s1">&#39;rate_change&#39;</span><span class="p">,</span><span class="s1">&#39;dir_rate_change&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># get min-max date of each cluster</span>
    <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;min_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_changes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cluster label&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span>

    <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;max_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_changes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cluster label&#39;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span>

    <span class="c1"># add an extra column that will hold info regarding with the number of changing points at each cluster</span>
    <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;cluster label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">data_changes</span><span class="p">[</span><span class="s2">&quot;cluster label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

    <span class="c1"># add score column</span>
    <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;cluster_abs_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;rate_change&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span>

    <span class="c1"># add  dir score column</span>
    <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;cluster_dir_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;dir_rate_change&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;counts&#39;</span><span class="p">]</span>

    <span class="c1"># Check if dates exist and add the min max date to the cluster dataframe</span>
    <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">data_changes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">min_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">max_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_clusters</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">min_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_changes</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data_changes</span><span class="p">[</span><span class="s1">&#39;cluster label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cluster label&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_changes</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;min_timestamp&#39;</span><span class="p">])][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">max_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_changes</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data_changes</span><span class="p">[</span><span class="s1">&#39;cluster label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;cluster label&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data_changes</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;max_timestamp&#39;</span><span class="p">])][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>


        <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;min_dates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_dates</span>
        <span class="n">data_clusters</span><span class="p">[</span><span class="s1">&#39;max_dates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_dates</span>

    <span class="c1"># Remove the local changes cluster </span>
    <span class="n">data_clusters</span> <span class="o">=</span> <span class="n">data_clusters</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span> <span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Sort the df according to the score </span>
    <span class="n">data_clusters</span> <span class="o">=</span> <span class="n">data_clusters</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cluster_abs_score&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_clusters</span> <span class="o">=</span> <span class="n">data_clusters</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_data</span><span class="p">,</span> <span class="n">data_clusters</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Athena Research Center, IMSI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>